<!DOCTYPE html>
<head>
<title>Self Regulating Drug Delivery System Simulation</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
function DataPoint(curtime, vd, tceil, tfloor, thalf, conc, infrate, sampint, plasmavol, drugmol, clearance) {
	this.curtime = curtime;				// s
	//Drug Params
	this.vd = parseFloat(vd);			// L
	this.tceil = parseFloat(tceil);		// uM
	this.tfloor = parseFloat(tfloor);	// uM
	this.thalf = parseFloat(thalf);		// hr
	//Infusion Params
	this.conc = parseFloat(conc);		// uM
	this.infrate = parseFloat(infrate);	// ml/hr
	this.sampint = parseFloat(sampint);	// s
	//Body Params
	this.plasmavol = parseFloat(plasmavol); // L
	this.drugmol = parseFloat(drugmol);		// umol
	this.clearance = parseFloat(clearance); // ml/min
	this.plasmaconc = -1;
	this.noisycp = -1;

	this.calcPlasmaConc = function (mean, stdev) {
		this.plasmaconc = this.drugmol / this.vd;
		this.noisycp = this.plasmaconc + random_bm(mean, stdev);
		if(this.noisycp < 0) this.noisycp = 0;
	};
	this.calcDrugMol = function() {
		cp = this.plasmaconc;
		drugremoved = cp * this.clearance / 60000 * this.sampint;
		drugadded = this.conc * this.infrate / 3600000 * this.sampint;
		newdrugmol = this.drugmol + drugadded - drugremoved;
		if(newdrugmol < 0) newdrugmol = 0;
		return newdrugmol;
	};

	this.step = function (mean,stdev) {
		NextStep = new DataPoint(this.curtime + this.sampint, this.vd, this.tceil, this.tfloor, this.thalf, 
									this.conc, this.infrate, this.sampint, this.plasmavol, this.calcDrugMol(), 
									this.clearance);
		NextStep.calcPlasmaConc(mean,stdev);
		return NextStep;
	};
	
	this.compareTo = function(dp) {
		return (dp.vd == this.vd) && (dp.tceil == this.tceil) && (dp.tfloor == this.tfloor) && (dp.thalf == this.thalf) && 
				(dp.conc == this.conc) && (dp.sampint == this.sampint) && (dp.plasmavol == this.plasmavol) && (dp.clearance == this.clearance);
	}
}

function CalcClearance(dp1, dp2) {
	//L/s
	var num1 = 2 * dp1.infrate * dp1.conc / 3600000;
	var dp1cp = dp1.noisycp;
	var dp2cp = dp2.noisycp;
	var denom1 = dp1cp + dp2cp;
	var num2 = 2 * dp1.vd * (dp1cp - dp2cp);
	var denom2 = (dp1cp + dp2cp) * dp1.sampint;
	return num1/denom1 + num2/denom2;
}

function random_bm(mean, stdev) {
    var u = 1 - Math.random(); // Subtraction to flip [0, 1) to (0, 1].
    var v = 1 - Math.random();
    return (Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v )) * stdev + mean;
}

function avg(cs) {
	var sum = 0;
	for(var i = 0; i < cs.length; i++) sum += cs[i];
	return sum/cs.length;
}
$(document).ready(function() {
	var ticker;
	var ctx = $("#display")[0].getContext('2d');
	var xint = 20;
	var yint = 22;
	var datapoints = [];
	var viewcounter = 0;
	var loadingdose = 0;
	var applyingloadingdose = false;
	var loadingdosepoints = [];
	var clearances = [];
	var calibrated = false;
	var calibrateinterval = 0;
	var calibratecount = 0;
	var prevclearance = 0;

	function UpdateDisplay() {
		ctx.clearRect(0,0,$("#display")[0].width,$("#display")[0].height);
		ctx.strokeStyle="#000000";
		ctx.moveTo(40,480);
		ctx.lineTo(40,20);
		ctx.stroke();
		ctx.moveTo(20,460);
		ctx.lineTo(980,460);
		ctx.stroke();
		ctx.strokeText("Cp/uM", 5, 10);
		ctx.strokeText("Time", 950, 480);
		var maxconc = 0;
		for(var i = viewcounter - 47; i < viewcounter; i++) {
			if(i < 0) i = 0;
			if(datapoints[i].plasmaconc > maxconc) maxconc = datapoints[i].plasmaconc;
			if(datapoints[i].tceil > maxconc) maxconc = datapoints[i].tceil;
		}
		if(maxconc == 0) maxconc = 5;
		var ypos = 460;
		for(var i = 0; i < 21; i++) {
			ctx.moveTo(35,ypos);
			ctx.lineTo(45,ypos);
			ctx.stroke();
			ctx.fillText((i/20 * maxconc).toFixed(2), 10, ypos);
			ypos -= yint;
		}
		var xpos = 60;
		for(var i = viewcounter - 47; i < viewcounter; i++) {
			if(i < 0) i = 0;
			if(i > 0) {
				if(!datapoints[i].compareTo(datapoints[i-1])) {
					ctx.strokeStyle = "#0000FF";
					ctx.moveTo(xpos-10,20);
					ctx.lineTo(xpos-10,460);
					ctx.stroke();
					ctx.strokeText("Vd:" + datapoints[i].vd + "(L)", xpos-5, 20);
					ctx.strokeText("Thalf:" + datapoints[i].thalf + "(hr)", xpos-5, 30);
					ctx.strokeText("Inf Conc:" + datapoints[i].conc + "(uM)", xpos-5, 40);
					ctx.strokeText("Inf Rate:" + datapoints[i].infrate + "(ml/hr)", xpos-5, 50);
					ctx.strokeText("Plasma vol:" + datapoints[i].plasmavol + "(L)", xpos-5, 60);
					ctx.strokeText("Clearance:" + datapoints[i].clearance + "(ml/min)", xpos-5, 70);
					ctx.strokeStyle = "#000000";
				}
			}
			ctx.moveTo(xpos, 455);
			ctx.lineTo(xpos, 465);
			ctx.stroke();
			if(datapoints[i].curtime/60 > 100) {
				ctx.strokeText((datapoints[i].curtime/3600).toFixed(1), xpos-10,470);
				ctx.strokeText("h", xpos-10,480);
			}
			else if(datapoints[i].curtime > 100) {
				ctx.strokeText((datapoints[i].curtime/60).toFixed(1), xpos-10,470);
				ctx.strokeText("m", xpos-10,480);
			}
			else ctx.strokeText(datapoints[i].curtime + "s", xpos-10,470);
			ctx.beginPath();
			ctx.arc(xpos, 460 - datapoints[i].plasmaconc / maxconc * 440, 5, 0, 2 * Math.PI);
			ctx.stroke();
			ctx.strokeStyle="#FF0000";
			ctx.moveTo(xpos - 5, 460 - datapoints[i].tceil / maxconc * 440);
			ctx.lineTo(xpos + 5, 460 - datapoints[i].tceil / maxconc * 440);
			ctx.stroke();
			ctx.moveTo(xpos - 5, 460 - datapoints[i].tfloor / maxconc * 440);
			ctx.lineTo(xpos + 5, 460 - datapoints[i].tfloor / maxconc * 440);
			ctx.stroke();
			ctx.strokeStyle="#000000";
			if(loadingdosepoints.includes(i)) {
				applyingloadingdose = false;
				ctx.strokeStyle="#00FF00";
				ctx.moveTo(xpos-10,20);
				ctx.lineTo(xpos-10,460);
				ctx.stroke();
				ctx.strokeText("Applying Loading Dose:" + loadingdose + "(umol)",xpos-5,20);
			}
			xpos += xint;
		}
	}
	function simulationloop() {
		UpdateDisplay();
		datapoints.push(datapoints[datapoints.length - 1].step(parseFloat($("#meanerr").val()), parseFloat($("#sdeverr").val())));
		viewcounter++;
		if(viewcounter > 1) {
			if(calibrated) {
				datapoints[datapoints.length-1].sampint = parseFloat($("#sampint").val());
				var predictedclearance = CalcClearance(datapoints[datapoints.length-2],datapoints[datapoints.length-1]); // L/s
				if(predictedclearance > 0) {
					clearances.push(predictedclearance);
					var Css = (datapoints[datapoints.length - 1].tceil + datapoints[datapoints.length - 1].tfloor)/2;
					var Doserate = Css * avg(clearances) * 3600; // umol / hr
					// L / hr -> ml/hr
					var newinfrate = Doserate / datapoints[datapoints.length - 1].conc * 1000;
					if(newinfrate < 0) newinfrate = 0;
					$("#infrate").val(newinfrate.toFixed(2));
					$("#drugmol").val(datapoints[datapoints.length-1].drugmol.toFixed(2));
					datapoints[datapoints.length - 1].infrate = newinfrate;
					if(!applyingloadingdose && loadingdose == 0) {
						loadingdose = Css * datapoints[datapoints.length-1].vd;
						loadingdose -= datapoints[datapoints.length-1].vd * datapoints[datapoints.length-1].noisycp;
						datapoints[datapoints.length-1].drugmol += loadingdose;
						applyingloadingdose = true;
						loadingdosepoints.push(datapoints.length-1);
					}
				}
			}
			else {
				var predictedclearance = CalcClearance(datapoints[datapoints.length-2],datapoints[datapoints.length-1]); // L/s
				if(predictedclearance > 0) clearances.push(predictedclearance);
				else calibratecount = 0;
				var predictedclearance = avg(clearances);
				if((predictedclearance-prevclearance)/predictedclearance < 0.025) calibratecount++;
				else calibratecount = 0;
				prevclearance = predictedclearance;
				if(calibratecount > 4)  {
					calibrated = true;
					alert(avg(clearances));
					$("#sampint").val(Math.log(2)/avg(clearances)/datapoints[datapoints.length-1].vd/10*3600);
				}
				$("#drugmol").val(datapoints[datapoints.length-1].drugmol);
			}
		}
	}

	$("#start").on("click", function() {
		window.clearInterval(ticker);
		if(datapoints.length == 0) var curtime = 0;
		else var curtime = datapoints[datapoints.length - 1].curtime + datapoints[datapoints.length - 1].sampint;
		var thalf = parseFloat($("#thalf").val());
		calibrateinterval = thalf*3600/10;
		var dp = new DataPoint(curtime, $("#vd").val(), $("#tceil").val(), $("#tfloor").val(), $("#thalf").val(), 
								$("#conc").val(), $("#infrate").val(), 60, $("#plasmavol").val(), 
								$("#drugmol").val(), $("#clearance").val());
		if(datapoints.length != 0) dp.drugmol = datapoints[datapoints.length - 1].drugmol;
		dp.calcPlasmaConc(parseFloat($("#meanerr").val()),parseFloat($("#sdeverr").val()));
		loadingdose = (dp.tceil + dp.tfloor)/2 * dp.vd;
		loadingdose -= dp.noisycp * dp.vd;
		var infrate = loadingdose / dp.conc * 1000;
		dp.infrate = infrate;
		$("#infrate").val(infrate);
		prevclearance = 0;
		calibratedcount = 0;
		calibrated = false;
		applyingloadingdose = false;
		loadingdose = 0;
		datapoints.push(dp);
		viewcounter = datapoints.length;
		ticker = window.setInterval(simulationloop, 1000);
	});

	$("#stop").on("click", function () {
		window.clearInterval(ticker);
	});
	$(".param").on("change", function() {
		window.clearInterval(ticker);
	});
	$("html").keydown(function(e) {
		if(viewcounter > 46) {
			if(e.keyCode == 37) {
				window.clearInterval(ticker);
				if(viewcounter > 47) {
					viewcounter--;
					UpdateDisplay();
				}
			}
			else if(e.keyCode == 39) {
				window.clearInterval(ticker);
				if(viewcounter < datapoints.length) {
					viewcounter++;
					UpdateDisplay();
				}
			}
		}
	});
});
</script>
</head>
<body>
<table border=0">
<tr>
<td>
<b>Standard Drug Parameters</b><br />
Volume of Distribution(L): <input type='number' id='vd' min="0" step="0.01" class="param"><br />
Therapeutic Ceiling(uM): <input type='number' id='tceil' min="0" step="0.01" class="param"><br />
Therapeutic Floor(uM): <input type='number' id='tfloor' min="0" step="0.01" class="param"><br />
Half-Life(hr): <input type='number' id='thalf' min="0" step="0.01" class="param"><br />
<b>Infusion Parameters</b><br />
Concentration of Infusion(uM): <input type='number' id='conc' step="0.01" min="0" class="param"><br />
Infusion Rate(ml/hr): <input type='number' id='infrate' step="0.01" min="0" class="param"><br />
Sampling Interval(s): <input type='number' id='sampint' step="0.01" min="0" class="param" value="1"><br />
<b>Patient Parameters</b><br />
Plasma Volume(L): <input type='number' id='plasmavol' min="0" step="0.01" value="3" class="param"><br />
Amount of drug in body(umol): <input type='number' id='drugmol' min="0" step="0.01" value="0" class="param"><br />
Total Clearance(ml/min): <input type='number' id='clearance' min="0" step="0.01" value="625" class="param"><br />
<b>Sensor Error</b><br />
Error Mean(uM): <input type='number' id='meanerr' min="0" step="0.01" value="0"><br />
Error stdev(uM): <input type='number' id='sdeverr' min="0" step="0.01" value="1"><br />
<button id='start'>Start Simulation</button><button id='stop'>Stop Simulation</button><br />
</td>
<td>
<canvas id='display' width="1000" height="500" style="border:1px solid"></canvas><br />
Tap arrow keys left and right to scroll
</td></tr></table>
</body>
</html>
