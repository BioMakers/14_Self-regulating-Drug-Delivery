<!DOCTYPE html>
<head>
<title>Self Regulating Drug Delivery System Simulation</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
function DataPoint(curtime, vd, tceil, tfloor, thalf, conc, infrate, sampint, plasmavol, drugmol, clearance) {
	this.curtime = curtime;
	//Drug Params
	this.vd = parseFloat(vd);			// L
	this.tceil = parseFloat(tceil);		// nM
	this.tfloor = parseFloat(tfloor);	// nM
	this.thalf = parseFloat(thalf);		// hr
	//Infusion Params
	this.conc = parseFloat(conc);		// nM
	this.infrate = parseFloat(infrate);	// ml/hr
	this.sampint = parseFloat(sampint);	// s
	//Body Params
	this.plasmavol = parseFloat(plasmavol); // L
	this.drugmol = parseFloat(drugmol);		// nmol
	this.clearance = parseFloat(clearance); // ml/min

	this.getPlasmaConc = function () {
		return this.drugmol / this.vd;
	};

	this.calcDrugMol = function() {
		cp = this.getPlasmaConc();
		drugremoved = cp * this.clearance / 60000 * this.sampint; 
		drugadded = this.conc * this.infrate / 3600000 * this.sampint;
		newdrugmol = this.drugmol + drugadded - drugremoved;
		if(newdrugmol < 0) newdrugmol = 0;
		return newdrugmol;
	};

	this.step = function () {
		NextStep = new DataPoint(this.curtime + this.sampint, this.vd, this.tceil, this.tfloor, this.thalf, 
									this.conc, this.infrate, this.sampint, this.plasmavol, this.calcDrugMol(), 
									this.clearance);
		return NextStep;
	};
	
	this.compareTo = function(dp) {
		return (dp.vd == this.vd) && (dp.tceil == this.tceil) && (dp.tfloor == this.tfloor) && (dp.thalf == this.thalf) && 
				(dp.conc == this.conc) && (dp.infrate == this.infrate) && (dp.sampint == this.sampint) && (dp.plasmavol == this.plasmavol) && 					(dp.clearance == this.clearance);
	}
}

$(document).ready(function() {
	var ticker;
	var ctx = $("#display")[0].getContext('2d');
	var xint = 20;
	var yint = 22;
	var datapoints = [];
	var viewcounter = 0;
	function UpdateDisplay() {
		ctx.clearRect(0,0,$("#display")[0].width,$("#display")[0].height);
		ctx.strokeStyle="#000000";
		ctx.moveTo(40,480);
		ctx.lineTo(40,20);
		ctx.stroke();
		ctx.moveTo(20,460);
		ctx.lineTo(980,460);
		ctx.stroke();
		ctx.strokeText("Cp/nM", 5, 10);
		ctx.strokeText("Time", 950, 480);
		var maxconc = 0;
		for(var i = viewcounter - 47; i < viewcounter; i++) {
			if(i < 0) i = 0;
			if(datapoints[i].getPlasmaConc() > maxconc) maxconc = datapoints[i].getPlasmaConc();
			if(datapoints[i].tceil > maxconc) maxconc = datapoints[i].tceil;
		}
		if(maxconc == 0) maxconc = 5;
		var ypos = 460;
		for(var i = 0; i < 21; i++) {
			ctx.moveTo(35,ypos);
			ctx.lineTo(45,ypos);
			ctx.stroke();
			ctx.fillText((i/20 * maxconc).toFixed(2), 10, ypos);
			ypos -= yint;
		}
		var xpos = 60;
		for(var i = viewcounter - 47; i < viewcounter; i++) {
			if(i < 0) i = 0;
			if(i > 0) {
				if(!datapoints[i].compareTo(datapoints[i-1])) {
					ctx.strokeStyle = "#0000FF";
					ctx.moveTo(xpos-10,20);
					ctx.lineTo(xpos-10,460);
					ctx.stroke();
					ctx.strokeText("Vd:" + datapoints[i].vd + "(L)", xpos-5, 20);
					ctx.strokeText("Thalf:" + datapoints[i].thalf + "(hr)", xpos-5, 30);
					ctx.strokeText("Inf Conc:" + datapoints[i].conc + "(uM)", xpos-5, 40);
					ctx.strokeText("Inf Rate:" + datapoints[i].infrate + "(ml/hr)", xpos-5, 50);
					ctx.strokeText("Plasma vol:" + datapoints[i].plasmavol + "(L)", xpos-5, 60);
					ctx.strokeText("Clearance:" + datapoints[i].clearance + "(ml/min)", xpos-5, 70);
					ctx.strokeStyle = "#000000";
				}
			}
			ctx.moveTo(xpos, 455);
			ctx.lineTo(xpos, 465);
			ctx.stroke();
			if(datapoints[i].curtime/60 > 100) {
				ctx.strokeText((datapoints[i].curtime/3600).toFixed(1), xpos-10,470);
				ctx.strokeText("h", xpos-10,480);
			}
			else if(datapoints[i].curtime > 100) {
				ctx.strokeText((datapoints[i].curtime/60).toFixed(1), xpos-10,470);
				ctx.strokeText("m", xpos-10,480);
			}
			else ctx.strokeText(datapoints[i].curtime + "s", xpos-10,470);
			ctx.beginPath();
			ctx.arc(xpos, 460 - datapoints[i].getPlasmaConc() / maxconc * 440, 5, 0, 2 * Math.PI);
			ctx.stroke();
			ctx.strokeStyle="#FF0000";
			ctx.moveTo(xpos - 5, 460 - datapoints[i].tceil / maxconc * 440);
			ctx.lineTo(xpos + 5, 460 - datapoints[i].tceil / maxconc * 440);
			ctx.stroke();
			ctx.moveTo(xpos - 5, 460 - datapoints[i].tfloor / maxconc * 440);
			ctx.lineTo(xpos + 5, 460 - datapoints[i].tfloor / maxconc * 440);
			ctx.stroke();
			ctx.strokeStyle="#000000";
			xpos += xint;
		}
	}
	function simulationloop() {
		UpdateDisplay();
		datapoints.push(datapoints[datapoints.length - 1].step());
		viewcounter++;
	}

	$("#start").on("click", function() {
		window.clearInterval(ticker);
		if(datapoints.length == 0) var curtime = 0;
		else var curtime = datapoints[datapoints.length - 1].curtime + datapoints[datapoints.length - 1].sampint;
		var dp = new DataPoint(curtime, $("#vd").val(), $("#tceil").val(), $("#tfloor").val(), $("#thalf").val(), 
								$("#conc").val(), $("#infrate").val(), $("#sampint").val(), $("#plasmavol").val(), 
								$("#drugmol").val(), $("#clearance").val());
		if(datapoints.length != 0) dp.drugmol = datapoints[datapoints.length - 1].drugmol;
		datapoints.push(dp);
		viewcounter = datapoints.length;
		ticker = window.setInterval(simulationloop, 1000);
	});

	$("#stop").on("click", function () {
		window.clearInterval(ticker);
	});
	$(".param").on("change", function() {
		window.clearInterval(ticker);
	});
	$("html").keydown(function(e) {
		if(viewcounter > 46) {
			if(e.keyCode == 37) {
				window.clearInterval(ticker);
				if(viewcounter > 47) {
					viewcounter--;
					UpdateDisplay();
				}
			}
			else if(e.keyCode == 39) {
				window.clearInterval(ticker);
				if(viewcounter < datapoints.length) {
					viewcounter++;
					UpdateDisplay();
				}
			}
		}
	});
});
</script>
</head>
<body>
<table border=0">
<tr>
<td>
<b>Standard Drug Parameters</b><br />
Volume of Distribution(L): <input type='number' id='vd' min="0" step="0.01" class="param"><br />
Therapeutic Ceiling(nM): <input type='number' id='tceil' min="0" step="0.01" class="param"><br />
Therapeutic Floor(nM): <input type='number' id='tfloor' min="0" step="0.01" class="param"><br />
Half-Life(hr): <input type='number' id='thalf' min="0" step="0.01" class="param"><br />
<b>Infusion Parameters</b><br />
Concentration of Infusion(nM): <input type='number' id='conc' step="0.01" min="0" class="param"><br />
Infusion Rate(ml/hr): <input type='number' id='infrate' step="0.01" min="0" class="param"><br />
Sampling Interval(s): <input type='number' id='sampint' step="0.01" min="0" class="param" value="1"><br />
<b>Patient Parameters</b><br />
Plasma Volume(L): <input type='number' id='plasmavol' min="0" step="0.01" value="3" class="param"><br />
Amount of drug in body(nmol): <input type='number' id='drugmol' min="0" step="0.01" value="0" class="param"><br />
Total Clearance(ml/min): <input type='number' id='clearance' min="0" step="0.01" value="625" class="param"><br />
<button id='start'>Start Simulation</button><button id='stop'>Stop Simulation</button><br />
</td>
<td>
<canvas id='display' width="1000" height="500" style="border:1px solid"></canvas><br />
Tap arrow keys left and right to scroll
</td></tr></table>
</body>
</html>
